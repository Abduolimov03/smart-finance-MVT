{% load humanize %}
{% load i18n %}

<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chiqimlar</title>
<style>
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f6f8; color:#333; margin:0; padding:0;}
header { background-color:#1e3a8a; color:#fff; padding:20px 30px; box-shadow:0 2px 8px rgba(0,0,0,0.2);}
header h1 { font-size:28px; margin-bottom:5px; }
header .total-sum { font-size:48px; font-weight:bold; color:#ffeb3b; text-shadow:1px 1px 2px rgba(0,0,0,0.3); margin:10px 0; }
header .subtitle { font-size:16px; color:rgba(255,255,255,0.85);}
.account-actions { margin-top:15px; }
.account-actions a { text-decoration:none; padding:8px 16px; border-radius:6px; font-weight:bold; color:#fff; margin-right:10px; transition:0.3s; }
.btn-edit { background-color:#10b981;} .btn-edit:hover { background-color:#059669;}
.btn-logout { background-color:#ef4444;} .btn-logout:hover { background-color:#b91c1c;}
nav { display:flex; justify-content:center; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
nav a { padding:15px 30px; text-decoration:none; color:#555; font-weight:bold; transition:0.3s;}
nav a.active, nav a:hover { color:#1e3a8a; border-bottom:3px solid #1e3a8a; }
main { max-width:900px; margin:30px auto; padding:0 15px;}
.card { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:30px;}
form input, form select { width:100%; padding:10px; margin:10px 0; border-radius:6px; border:1px solid #ccc; font-size:16px;}
button.submit-btn { background-color:#1e3a8a; color:#fff; font-weight:bold; border:none; padding:12px 25px; border-radius:6px; cursor:pointer; transition:0.3s;}
button.submit-btn:hover { background-color:#16295c;}
.expense-list li { background:#fff; padding:15px 20px; border-radius:8px; margin-bottom:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;}
.expense-list .info { flex:1; }
.expense-list .info span.title { font-weight:bold; margin-right:10px; }
.expense-list .info span.date { color:#888; font-size:14px; margin-left:10px; }
.actions a { text-decoration:none; padding:6px 12px; border-radius:6px; color:#fff; font-weight:bold; margin-left:5px; transition:0.3s;}
.btn-edit { background-color:#3b82f6; } .btn-edit:hover { background-color:#2563eb; }
.btn-delete { background-color:#ef4444; } .btn-delete:hover { background-color:#b91c1c; }
.stats { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px; }
.stats .stat-card { flex:1 1 180px; background:#dc2626; color:#fff; padding:15px; border-radius:8px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
.stats .stat-card h3 { margin-bottom:5px; font-size:16px; }
.stats .stat-card p { font-size:20px; font-weight:bold; }
.date-filter { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; align-items:center;}
.date-filter label { font-weight:bold;}
.date-filter input { flex:1 1 150px;}
.toggle-buttons { margin-bottom:15px; }
.toggle-buttons a { padding:6px 12px; border-radius:6px; color:#fff; text-decoration:none; font-weight:bold; margin-right:5px; transition:0.3s;}
.toggle-buttons a:hover { opacity:0.85; }
.btn-day { background:#3b82f6; } .btn-week { background:#2563eb; } .btn-month { background:#10b981; } .btn-year { background:#f59e0b; }
.message { padding:10px; margin-bottom:15px; border-radius:6px; }
.message.error { background:#fef2f2; color:#b91c1c; }
.message.success { background:#ecfdf5; color:#059669; }
.tab-content { display:none; animation:fadeIn 0.4s ease-in-out;}
.tab-content.active { display:block; }
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
@media(max-width:600px) { nav { flex-direction:column; } nav a { border-bottom:none; padding:12px; } .expense-list li { flex-direction:column; align-items:flex-start; } .actions { margin-top:10px; } .stats { flex-direction:column; } .date-filter { flex-direction:column; align-items:flex-start; } }
</style>
</head>
<body>

<header>
    <h1>Xush kelibsiz, {{ request.user.username }}!</h1>
    <div class="total-sum">{{ balance|intcomma }} so‚Äòm</div>
    <p class="subtitle">Umumiy balans</p>
    <div class="account-actions">
        <a href="{% url 'change_profile' %}" class="btn-edit">Profilni o'zgartirish</a>
        <a href="{% url 'logout' %}" class="btn-logout">Chiqish</a>
    </div>
</header>

<nav>
    <a href="{% url 'home' %}" class="{% if request.resolver_match.url_name == 'home' %}active{% endif %}">Kirimlar</a>
    <a href="{% url 'expense_home' %}" class="{% if request.resolver_match.url_name == 'expense_home' %}active{% endif %}">Chiqimlar</a>
    <a href="#" class="tab-link" data-tab="profil">Profil</a>
</nav>

<main>
    <!-- Chiqimlar tab -->
    <section id="chiqim" class="tab-content active">
        <!-- Filtr -->
        <div class="card">
            <h2>Vaqt oralig‚Äòi bo‚Äòyicha chiqimlarni ko‚Äòrish</h2>
            <form method="get" action="{% url 'expense_home' %}">
                <div class="date-filter">
                    <label for="start_date">Boshlanish sanasi:</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date|default:'' }}">
                    <label for="end_date">Tugash sanasi:</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date|default:'' }}">
                    <button type="submit" class="submit-btn">Filtr</button>
                </div>
            </form>
            {% if range_total %}
            <p><strong>Tanlangan davr chiqimi:</strong> {{ range_total|intcomma }} so‚Äòm</p>
            {% endif %}
        </div>

        <!-- Statistikalar -->
        <div class="stats">
            <div class="stat-card">
                <h3>Bugungi chiqim</h3>
                <p>{{ daily_total|intcomma }} so‚Äòm</p>
            </div>
            <div class="stat-card">
                <h3>Haftalik chiqim</h3>
                <p>{{ weekly_total|intcomma }} so‚Äòm</p>
            </div>
            <div class="stat-card">
                <h3>Oylik chiqim</h3>
                <p>{{ monthly_total|intcomma }} so‚Äòm</p>
            </div>
            <div class="stat-card">
                <h3>Yillik chiqim</h3>
                <p>{{ yearly_total|intcomma }} so‚Äòm</p>
            </div>
        </div>

        <!-- Grafik -->
        <div class="card">
            <h2>Chiqimlar grafigi</h2>
            <div class="toggle-buttons">
                <a href="?period=day" class="btn-day">Kunlik</a>
                <a href="?period=week" class="btn-week">Haftalik</a>
                <a href="?period=month" class="btn-month">Oylik</a>
                <a href="?period=year" class="btn-year">Yillik</a>
            </div>
            <canvas id="expenseChart" height="150"></canvas>
        </div>

        <!-- Yangi chiqim qo‚Äòshish -->
        <div class="card">
            <h2>Yangi chiqim qo‚Äòshish</h2>
            <form method="post" action="{% url 'expense_add' %}">
                {% csrf_token %}
                <input type="text" name="title" placeholder="Chiqim nomi" required>
                <input type="number" name="amount" placeholder="Summasi" required>
                <select name="payment_method">
                    <option value="naqt">Naqt</option>
                    <option value="karta">Karta</option>
                    <option value="dollar">Dollar</option>
                </select>
                <button type="submit" class="submit-btn">Qo‚Äòshish</button>
            </form>
        </div>

        {% if messages %}
        {% for message in messages %}
            <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
        {% endif %}

        <!-- Chiqimlar ro‚Äòyxati -->
        <div class="card">
            <h2>Chiqimlar ro‚Äòyxati</h2>
            <ul class="expense-list">
                {% for expense in expenses %}
                <li>
                    <div class="info">
                        <span class="title">{{ expense.title }}</span> ‚Äì
                        <span class="amount">{{ expense.amount|intcomma }} so‚Äòm</span>
                        <span class="date">({{ expense.created_at|date:"d-m-Y H:i" }})</span>
                    </div>
                    <div class="actions">
                        <a href="{% url 'expense_update' expense.id %}" class="btn-edit">‚úèÔ∏è Tahrirlash</a>
                        <a href="{% url 'expense_delete' expense.id %}" class="btn-delete">üóë O‚Äòchirish</a>
                    </div>
                </li>
                {% empty %}
                <li>Hozircha chiqimlar yo‚Äòq</li>
                {% endfor %}
            </ul>
        </div>
    </section>

    <!-- Profil tab -->
    <section id="profil" class="tab-content">
        <div class="card">
            <h2>Profil ma‚Äôlumotlari</h2>
            <p><strong>Username:</strong> {{ request.user.username }}</p>
            <p><strong>Email:</strong> {{ request.user.email }}</p>
            <p><strong>Telefon:</strong> {{ request.user.phone_number }}</p>
            <div class="account-actions">
                <a href="{% url 'change_profile' %}" class="btn-edit">Profilni o'zgartirish</a>
                <a href="{% url 'logout' %}" class="btn-logout">Chiqish</a>
            </div>
        </div>
    </section>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Tab toggle
document.querySelectorAll('.tab-link').forEach(tab => {
    tab.addEventListener('click', e => {
        e.preventDefault();
        const target = tab.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(s => s.classList.remove('active'));
        document.getElementById(target).classList.add('active');
        document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
    });
});

// Chart.js
const ctx = document.getElementById('expenseChart').getContext('2d');
let chartLabel = "{% if period == 'week' %}Haftalik chiqim{% elif period == 'month' %}Oylik chiqim{% elif period == 'year' %}Yillik chiqim{% else %}Kunlik chiqim{% endif %}";
const expenseChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ chart_labels|safe }},
        datasets: [{
            label: chartLabel,
            data: {{ chart_values|safe }},
            backgroundColor: 'rgba(239, 68, 68, 0.2)',
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: true },
            tooltip: { mode: 'index', intersect: false }
        },
        scales: {
            x: { display: true, title: { display: true, text: 'Sana' } },
            y: { display: true, title: { display: true, text: 'Summa (so‚Äòm)' } }
        }
    }
});
</script>

</body>
</html>
